-- ServerScriptService > Script

local TRAIL_SETTINGS = {
    Lifetime = 0.6,               -- duração do rastro
    MinWidth = 0.15,
    MaxWidth = 0.35,
    Color = Color3.fromRGB(255, 0, 0),
    Transparency = NumberSequence.new(0.1, 0.9), -- começa quase sólido e some
    AttachmentOffset0 = Vector3.new(0, -0.5, -0.3), -- levemente abaixo/atrás
    AttachmentOffset1 = Vector3.new(0, -0.5, -1.6), -- mais atrás
    FaceCamera = false,
    LightInfluence = 1,
}

local function ensureAttachment(parent: Instance, name: string, offset: Vector3)
    local att = parent:FindFirstChild(name)
    if not att then
        att = Instance.new("Attachment")
        att.Name = name
        att.Parent = parent
    end
    att.Position = offset
    return att
end

local function addTrailToCharacter(character: Model)
    local hrp = character:FindFirstChild("HumanoidRootPart")
    if not hrp then
        character.ChildAdded:Once(function(child)
            if child.Name == "HumanoidRootPart" then
                task.defer(addTrailToCharacter, character)
            end
        end)
        return
    end

    -- Evita duplicar
    local existing = hrp:FindFirstChild("RedTrail")
    if existing then
        existing:Destroy()
    end

    local att0 = ensureAttachment(hrp, "TrailAtt0", TRAIL_SETTINGS.AttachmentOffset0)
    local att1 = ensureAttachment(hrp, "TrailAtt1", TRAIL_SETTINGS.AttachmentOffset1)

    local trail = Instance.new("Trail")
    trail.Name = "RedTrail"
    trail.Attachment0 = att0
    trail.Attachment1 = att1
    trail.Lifetime = TRAIL_SETTINGS.Lifetime
    trail.MinLength = 0        -- deixa o rastro começar imediatamente
    trail.FaceCamera = TRAIL_SETTINGS.FaceCamera
    trail.LightInfluence = TRAIL_SETTINGS.LightInfluence
    trail.Transparency = TRAIL_SETTINGS.Transparency
    trail.WidthScale = NumberSequence.new(TRAIL_SETTINGS.MinWidth, TRAIL_SETTINGS.MaxWidth)
    trail.Color = ColorSequence.new(TRAIL_SETTINGS.Color)
    trail.Enabled = true
    trail.Parent = hrp
end

game.Players.PlayerAdded:Connect(function(player)
    local function onCharacterAdded(char)
        addTrailToCharacter(char)
    end
    player.CharacterAdded:Connect(onCharacterAdded)
    if player.Character then
        onCharacterAdded(player.Character)
    end
end)
